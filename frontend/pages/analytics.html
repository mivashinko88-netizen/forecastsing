<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - TrucastAI</title>
    <link rel="stylesheet" href="/frontend/css/main.css">
    <link rel="stylesheet" href="/frontend/css/components.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
        }

        .page-header {
            background: linear-gradient(135deg, #0D9488 0%, #14B8A6 100%);
            border-bottom: none;
            padding: var(--space-4) var(--space-6);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-header h1 {
            font-size: 20px;
            font-weight: 600;
            color: white;
        }

        .page-header p {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            margin-top: 2px;
        }

        .page-content {
            padding: var(--space-5);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: var(--space-1);
            background: white;
            padding: 4px;
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-5);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .tab-btn {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .tab-btn:hover {
            background: var(--gray-50);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #0D9488 0%, #14B8A6 100%);
            color: white;
        }

        .tab-btn svg {
            width: 18px;
            height: 18px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-5);
        }

        .metric-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .metric-card.purple::before { background: linear-gradient(90deg, #0D9488, #14B8A6); }
        .metric-card.green::before { background: linear-gradient(90deg, #10b981, #34d399); }
        .metric-card.blue::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .metric-card.orange::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }

        .metric-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-500);
            text-transform: uppercase;
            margin-bottom: var(--space-2);
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .metric-subtext {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: var(--space-1);
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: var(--space-5);
        }

        .card-header {
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .card-title svg {
            width: 20px;
            height: 20px;
            color: var(--primary-500);
        }

        .card-body {
            padding: var(--space-5);
        }

        /* Chart container */
        .chart-container {
            height: 350px;
        }

        /* Input Form */
        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-5);
        }

        .input-form {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .form-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-600);
        }

        .entries-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .entry-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: white;
            border-radius: var(--radius-md);
            margin-bottom: var(--space-2);
        }

        .entry-info {
            flex: 1;
        }

        .entry-date {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .entry-item-name {
            font-size: 12px;
            color: var(--gray-500);
        }

        .entry-qty {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-600);
        }

        .btn-remove {
            background: transparent;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            padding: 4px;
        }

        .btn-remove:hover {
            color: var(--error-500);
        }

        /* Period Toggle */
        .period-toggle {
            display: flex;
            background: var(--gray-100);
            border-radius: var(--radius-md);
            padding: 3px;
        }

        .period-btn {
            padding: var(--space-2) var(--space-3);
            border: none;
            background: transparent;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            border-radius: var(--radius);
        }

        .period-btn.active {
            background: white;
            color: var(--gray-900);
            box-shadow: var(--shadow-sm);
        }

        /* Comparison table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }

        .comparison-table th,
        .comparison-table td {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            border-bottom: 1px solid var(--gray-100);
        }

        .comparison-table th {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .comparison-table td {
            font-size: 14px;
            color: var(--gray-900);
        }

        .variance-positive {
            color: var(--success-600);
        }

        .variance-negative {
            color: var(--error-600);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: var(--space-8);
            color: var(--gray-500);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            color: var(--gray-300);
            margin-bottom: var(--space-4);
        }

        .empty-state h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--space-2);
        }

        /* Grid layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-5);
        }

        @media (max-width: 1024px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/frontend/pages/home.html" class="sidebar-logo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    TrucastAI
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <a href="/frontend/pages/dashboard.html" class="sidebar-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                        </svg>
                        Dashboard
                    </a>
                    <a href="/frontend/pages/forecast.html" class="sidebar-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"/>
                            <path d="M18 9l-5-6-4 8-3-2"/>
                        </svg>
                        Forecasts
                    </a>
                    <a href="/frontend/pages/calendar.html" class="sidebar-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        Calendar
                    </a>
                    <a href="/frontend/pages/upload.html" class="sidebar-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Upload Data
                    </a>
                    <a href="/frontend/pages/analytics.html" class="sidebar-item active">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"/>
                            <line x1="12" y1="20" x2="12" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="14"/>
                        </svg>
                        Analytics
                    </a>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Settings</div>
                    <a href="/frontend/pages/account.html" class="sidebar-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        Account
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1>Analytics</h1>
                    <p>Track accuracy and compare predictions vs actual sales</p>
                </div>
            </div>

            <div class="page-content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('accuracy')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        Accuracy Tracking
                    </button>
                    <button class="tab-btn" onclick="switchTab('history')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Historical Comparison
                    </button>
                    <button class="tab-btn" onclick="switchTab('input')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Enter Actual Sales
                    </button>
                </div>

                <!-- Accuracy Tab -->
                <div id="accuracyTab" class="tab-content active">
                    <!-- Info banner shown when no data -->
                    <div id="noDataBanner" class="card" style="border-left: 4px solid #3b82f6; margin-bottom: var(--space-5); display: none;">
                        <div class="card-body" style="padding: var(--space-4);">
                            <div style="display: flex; gap: var(--space-3); align-items: flex-start;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="12" y1="16" x2="12" y2="12"/>
                                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                                </svg>
                                <div>
                                    <h4 style="font-size: 15px; font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">How Accuracy Tracking Works</h4>
                                    <p style="font-size: 13px; color: var(--gray-600); line-height: 1.5; margin-bottom: 8px;">
                                        To see accuracy metrics:
                                    </p>
                                    <ol style="font-size: 13px; color: var(--gray-600); line-height: 1.8; margin: 0; padding-left: 20px;">
                                        <li><strong>Generate predictions</strong> from the Forecasts page for upcoming dates</li>
                                        <li><strong>Wait for those dates to pass</strong> (get actual sales)</li>
                                        <li><strong>Upload new data</strong> containing those dates - auto-compare will match them!</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="metrics-grid" id="metricsGrid">
                        <div class="metric-card purple">
                            <div class="metric-label">Accuracy</div>
                            <div class="metric-value" id="metricAccuracy">--%</div>
                            <div class="metric-subtext">Based on tracked days</div>
                        </div>
                        <div class="metric-card green">
                            <div class="metric-label">Total Predicted</div>
                            <div class="metric-value" id="metricPredicted">--</div>
                            <div class="metric-subtext">Units forecasted</div>
                        </div>
                        <div class="metric-card blue">
                            <div class="metric-label">Total Actual</div>
                            <div class="metric-value" id="metricActual">--</div>
                            <div class="metric-subtext">Units sold</div>
                        </div>
                        <div class="metric-card orange">
                            <div class="metric-label">Days Tracked</div>
                            <div class="metric-value" id="metricDays">--</div>
                            <div class="metric-subtext">With actual data</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 3v18h18"/>
                                    <path d="M18 9l-5-6-4 8-3-2"/>
                                </svg>
                                Predicted vs Actual
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="comparisonChart" class="chart-container"></div>
                        </div>
                    </div>
                </div>

                <!-- Historical Tab -->
                <div id="historyTab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                Period Comparison
                            </div>
                            <div class="period-toggle">
                                <button class="period-btn" onclick="setPeriod('week')">Week</button>
                                <button class="period-btn active" onclick="setPeriod('month')">Month</button>
                                <button class="period-btn" onclick="setPeriod('quarter')">Quarter</button>
                                <button class="period-btn" onclick="setPeriod('year')">Year</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="metrics-grid" style="margin-bottom: var(--space-5);">
                                <div class="metric-card purple">
                                    <div class="metric-label">Current Period</div>
                                    <div class="metric-value" id="currentPeriodValue">--</div>
                                    <div class="metric-subtext">Actual sales</div>
                                </div>
                                <div class="metric-card blue">
                                    <div class="metric-label">Previous Period</div>
                                    <div class="metric-value" id="previousPeriodValue">--</div>
                                    <div class="metric-subtext">Actual sales</div>
                                </div>
                                <div class="metric-card green">
                                    <div class="metric-label">Change</div>
                                    <div class="metric-value" id="periodChange">--%</div>
                                    <div class="metric-subtext">vs previous</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Sales by Day of Week</div>
                            </div>
                            <div class="card-body">
                                <div id="dowChart" class="chart-container"></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Top Items Comparison</div>
                            </div>
                            <div class="card-body">
                                <div id="itemsComparisonTable"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Tab -->
                <div id="inputTab" class="tab-content">
                    <!-- Auto-compare explanation -->
                    <div class="card" style="border-left: 4px solid #10b981; margin-bottom: var(--space-5);">
                        <div class="card-body" style="padding: var(--space-4);">
                            <div style="display: flex; gap: var(--space-3); align-items: flex-start;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M9 12l2 2 4-4"/>
                                </svg>
                                <div>
                                    <h4 style="font-size: 15px; font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">Auto-Compare Enabled</h4>
                                    <p style="font-size: 13px; color: var(--gray-600); line-height: 1.5;">
                                        When you upload new sales data, the system automatically compares it against previous predictions for those dates.
                                        Your accuracy metrics will update without any manual entry. Simply keep uploading your regular sales data and watch your model improve!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                                Manual Entry (Optional)
                            </div>
                        </div>
                        <div class="card-body">
                            <p style="font-size: 13px; color: var(--gray-500); margin-bottom: var(--space-4);">
                                Use this form for quick spot-checks or to record individual sales that weren't in your regular data upload.
                            </p>
                            <div class="input-section">
                                <div class="input-form">
                                    <h4 style="margin-bottom: var(--space-4); font-size: 14px; font-weight: 600;">Add Sales Entry</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Date</label>
                                            <input type="date" class="input" id="entryDate">
                                        </div>
                                        <div class="form-group">
                                            <label>Item</label>
                                            <select class="input" id="entryItem">
                                                <option value="">Select item...</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Quantity Sold</label>
                                            <input type="number" class="input" id="entryQty" min="0" placeholder="0">
                                        </div>
                                        <button class="btn btn-primary" onclick="addEntry()">Add</button>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="margin-bottom: var(--space-4); font-size: 14px; font-weight: 600;">Pending Entries</h4>
                                    <div class="entries-list" id="entriesList">
                                        <div class="empty-state" style="padding: var(--space-4);">
                                            <p>No entries yet. Add sales data above.</p>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" style="width: 100%; margin-top: var(--space-4);" onclick="saveEntries()" id="saveBtn" disabled>
                                        Save All Entries
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/frontend/js/api.js"></script>
    <script>
        if (!api.isAuthenticated()) {
            window.location.href = '/frontend/pages/login.html';
        }

        let businessId = null;
        let pendingEntries = [];
        let trainedItems = [];
        let currentPeriod = 'month';

        async function init() {
            try {
                const businesses = await api.getBusinesses();
                if (!businesses || businesses.length === 0) {
                    return;
                }
                businessId = businesses[0].id;

                // Load trained items for the dropdown
                await loadTrainedItems();

                // Set default date to yesterday
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                document.getElementById('entryDate').value = yesterday.toISOString().split('T')[0];

                // Load accuracy data
                await loadAccuracyData();
                await loadHistoricalData();
            } catch (error) {
                console.error('Init error:', error);
            }
        }

        async function loadTrainedItems() {
            try {
                const models = await api.getModels(businessId);
                const activeModel = models.find(m => m.is_active);
                if (activeModel && activeModel.items_trained) {
                    trainedItems = JSON.parse(activeModel.items_trained);
                    const select = document.getElementById('entryItem');
                    select.innerHTML = '<option value="">Select item...</option>';
                    trainedItems.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        option.textContent = item;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load items:', error);
            }
        }

        async function loadAccuracyData() {
            try {
                const response = await fetch(`/api/businesses/${businessId}/accuracy?days=30`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (!response.ok) return;

                const data = await response.json();

                if (!data.has_data) {
                    // Show the info banner explaining how to get data
                    document.getElementById('noDataBanner').style.display = 'block';
                    document.getElementById('comparisonChart').innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M3 3v18h18"/>
                                <path d="M18 9l-5-6-4 8-3-2"/>
                            </svg>
                            <h3>No Comparison Data Yet</h3>
                            <p style="max-width: 400px; margin: 0 auto;">Generate predictions, then upload data containing those dates. The system will automatically compare predicted vs actual sales!</p>
                        </div>
                    `;
                    return;
                }

                // Hide info banner when we have data
                document.getElementById('noDataBanner').style.display = 'none';

                // Update metrics
                document.getElementById('metricAccuracy').textContent = `${data.metrics.accuracy}%`;
                document.getElementById('metricPredicted').textContent = data.metrics.total_predicted.toLocaleString();
                document.getElementById('metricActual').textContent = data.metrics.total_actual.toLocaleString();
                document.getElementById('metricDays').textContent = data.metrics.days_tracked;

                // Render comparison chart
                renderComparisonChart(data.daily_comparison);
            } catch (error) {
                console.error('Failed to load accuracy data:', error);
            }
        }

        function renderComparisonChart(dailyData) {
            if (!dailyData || dailyData.length === 0) return;

            const dates = dailyData.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

            const traces = [
                {
                    x: dates,
                    y: dailyData.map(d => d.predicted),
                    name: 'Predicted',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#14B8A6', width: 2 },
                    marker: { size: 6 }
                },
                {
                    x: dates,
                    y: dailyData.map(d => d.actual),
                    name: 'Actual',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#10B981', width: 2 },
                    marker: { size: 6 }
                }
            ];

            const layout = {
                font: { family: '-apple-system, BlinkMacSystemFont, sans-serif' },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                margin: { t: 20, r: 20, b: 60, l: 60 },
                xaxis: { gridcolor: '#E5E7EB', tickangle: -45 },
                yaxis: { gridcolor: '#E5E7EB', title: 'Units' },
                legend: { orientation: 'h', y: -0.25, x: 0.5, xanchor: 'center' }
            };

            Plotly.newPlot('comparisonChart', traces, layout, { responsive: true, displayModeBar: false });
        }

        async function loadHistoricalData() {
            try {
                const response = await fetch(`/api/businesses/${businessId}/history?period=${currentPeriod}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (!response.ok) return;

                const data = await response.json();

                // Update period metrics
                document.getElementById('currentPeriodValue').textContent = data.current_period.actual.toLocaleString();
                document.getElementById('previousPeriodValue').textContent = data.previous_period.actual.toLocaleString();

                const changeEl = document.getElementById('periodChange');
                changeEl.textContent = `${data.change_percent > 0 ? '+' : ''}${data.change_percent}%`;
                changeEl.style.color = data.change_percent >= 0 ? 'var(--success-600)' : 'var(--error-600)';

                // Render day of week chart
                renderDowChart(data.by_day_of_week);

                // Render items table
                renderItemsTable(data.by_item);
            } catch (error) {
                console.error('Failed to load historical data:', error);
            }
        }

        function renderDowChart(dowData) {
            if (!dowData || dowData.length === 0) {
                document.getElementById('dowChart').innerHTML = '<div class="empty-state"><p>No data available</p></div>';
                return;
            }

            const traces = [
                {
                    x: dowData.map(d => d.day.substring(0, 3)),
                    y: dowData.map(d => d.avg_predicted),
                    name: 'Avg Predicted',
                    type: 'bar',
                    marker: { color: '#14B8A6' }
                },
                {
                    x: dowData.map(d => d.day.substring(0, 3)),
                    y: dowData.map(d => d.avg_actual),
                    name: 'Avg Actual',
                    type: 'bar',
                    marker: { color: '#10B981' }
                }
            ];

            const layout = {
                font: { family: '-apple-system, BlinkMacSystemFont, sans-serif' },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                margin: { t: 20, r: 20, b: 60, l: 60 },
                xaxis: { gridcolor: '#E5E7EB' },
                yaxis: { gridcolor: '#E5E7EB', title: 'Avg Units' },
                legend: { orientation: 'h', y: -0.2, x: 0.5, xanchor: 'center' },
                barmode: 'group'
            };

            Plotly.newPlot('dowChart', traces, layout, { responsive: true, displayModeBar: false });
        }

        function renderItemsTable(items) {
            const container = document.getElementById('itemsComparisonTable');

            if (!items || items.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No data available</p></div>';
                return;
            }

            container.innerHTML = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Predicted</th>
                            <th>Actual</th>
                            <th>Variance</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => {
                            const variance = item.actual - item.predicted;
                            const varianceClass = variance >= 0 ? 'variance-positive' : 'variance-negative';
                            return `
                                <tr>
                                    <td>${item.item}</td>
                                    <td>${item.predicted.toLocaleString()}</td>
                                    <td>${item.actual.toLocaleString()}</td>
                                    <td class="${varianceClass}">${variance > 0 ? '+' : ''}${variance.toLocaleString()}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function setPeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadHistoricalData();
        }

        function addEntry() {
            const date = document.getElementById('entryDate').value;
            const item = document.getElementById('entryItem').value;
            const qty = parseInt(document.getElementById('entryQty').value);

            if (!date || !item || isNaN(qty)) {
                alert('Please fill in all fields');
                return;
            }

            pendingEntries.push({ date, item_name: item, actual_quantity: qty });
            renderEntries();

            // Clear inputs
            document.getElementById('entryQty').value = '';
        }

        function removeEntry(index) {
            pendingEntries.splice(index, 1);
            renderEntries();
        }

        function renderEntries() {
            const container = document.getElementById('entriesList');

            if (pendingEntries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-4);">
                        <p>No entries yet. Add sales data above.</p>
                    </div>
                `;
                document.getElementById('saveBtn').disabled = true;
                return;
            }

            document.getElementById('saveBtn').disabled = false;

            container.innerHTML = pendingEntries.map((entry, i) => `
                <div class="entry-item">
                    <div class="entry-info">
                        <div class="entry-date">${new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                        <div class="entry-item-name">${entry.item_name}</div>
                    </div>
                    <div class="entry-qty">${entry.actual_quantity}</div>
                    <button class="btn-remove" onclick="removeEntry(${i})">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        async function saveEntries() {
            if (pendingEntries.length === 0) return;

            try {
                const response = await fetch(`/api/businesses/${businessId}/actuals`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ entries: pendingEntries })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Saved ${result.updated + result.created} entries successfully!`);
                    pendingEntries = [];
                    renderEntries();
                    await loadAccuracyData();
                    await loadHistoricalData();
                } else {
                    alert('Failed to save entries');
                }
            } catch (error) {
                console.error('Error saving entries:', error);
                alert('Failed to save entries');
            }
        }

        init();
    </script>
</body>
</html>
