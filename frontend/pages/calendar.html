<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar - TrucastAI</title>
    <script src="/frontend/js/theme.js"></script>
    <link rel="stylesheet" href="/frontend/css/main.css">
    <link rel="stylesheet" href="/frontend/css/components.css">
    <link rel="stylesheet" href="/frontend/css/techy-theme.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--techy-bg-void, #0a0a0f);
            min-height: 100vh;
            color: var(--techy-text-primary, #f1f5f9);
        }

        /* Weather Effects Container - Subtle */
        .weather-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
            opacity: 0.4;
        }

        /* Sunny Effect */
        .weather-sunny .main-content {
            background: linear-gradient(180deg, #f0fdfa 0%, #f8fafc 30%);
        }

        .weather-sunny .sun {
            position: absolute;
            top: 20px;
            right: 100px;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #FFD700, #FFA500);
            border-radius: 50%;
            box-shadow: 0 0 40px 15px rgba(255, 215, 0, 0.3);
            animation: pulse-sun 4s ease-in-out infinite;
        }

        @keyframes pulse-sun {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        /* Cloudy Effect */
        .weather-cloudy .main-content {
            background: linear-gradient(180deg, #f1f5f9 0%, #f8fafc 30%);
        }

        .cloud {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.7;
            filter: blur(3px);
        }

        .cloud::before, .cloud::after {
            content: '';
            position: absolute;
            background: white;
            border-radius: 50%;
        }

        .cloud-1 { width: 80px; height: 32px; top: 30px; left: 10%; animation: float-cloud 30s linear infinite; }
        .cloud-1::before { width: 40px; height: 40px; top: -20px; left: 12px; }
        .cloud-1::after { width: 48px; height: 48px; top: -24px; left: 36px; }

        .cloud-2 { width: 64px; height: 26px; top: 60px; left: 50%; animation: float-cloud 35s linear infinite; animation-delay: -12s; }
        .cloud-2::before { width: 32px; height: 32px; top: -16px; left: 8px; }
        .cloud-2::after { width: 40px; height: 40px; top: -20px; left: 28px; }

        .cloud-3 { width: 96px; height: 38px; top: 25px; left: 70%; animation: float-cloud 40s linear infinite; animation-delay: -24s; }
        .cloud-3::before { width: 48px; height: 48px; top: -24px; left: 16px; }
        .cloud-3::after { width: 56px; height: 56px; top: -28px; left: 44px; }

        @keyframes float-cloud {
            0% { transform: translateX(0); }
            100% { transform: translateX(-200vw); }
        }

        /* Rain Effect */
        .weather-rainy .main-content {
            background: linear-gradient(180deg, #e2e8f0 0%, #f1f5f9 30%);
        }

        .rain {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .rain-drop {
            position: absolute;
            width: 1px;
            height: 15px;
            background: linear-gradient(transparent, rgba(148, 163, 184, 0.6));
            animation: rain-fall linear infinite;
        }

        @keyframes rain-fall {
            0% { transform: translateY(-100px); opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0.2; }
        }

        /* Snow Effect */
        .weather-snowy .main-content {
            background: linear-gradient(180deg, #f1f5f9 0%, #f8fafc 30%);
        }

        .snowflake {
            position: absolute;
            color: #94a3b8;
            text-shadow: 0 0 3px rgba(255,255,255,0.6);
            animation: snow-fall linear infinite;
            opacity: 0.6;
        }

        @keyframes snow-fall {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0.2; }
        }

        /* Night Effect */
        .weather-night .main-content {
            background: linear-gradient(180deg, #1e293b 0%, #334155 30%, #475569 60%);
        }

        .weather-night .page-header,
        .weather-night .calendar-card {
            background: rgba(30, 41, 59, 0.95);
            border-color: rgba(71, 85, 105, 0.5);
        }

        .weather-night .page-header h1,
        .weather-night .current-month,
        .weather-night .calendar-header-cell {
            color: #f1f5f9;
        }

        .weather-night .page-header p {
            color: #94a3b8;
        }

        .weather-night .calendar-cell {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(71, 85, 105, 0.3);
        }

        .weather-night .calendar-cell:hover {
            background: rgba(51, 65, 85, 0.8);
        }

        .weather-night .day-number {
            color: #f1f5f9;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .moon {
            position: absolute;
            top: 25px;
            right: 100px;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #f5f5dc, #e8e8c8);
            border-radius: 50%;
            box-shadow: 0 0 20px 8px rgba(255, 255, 220, 0.2);
        }

        /* Weather Badge */
        .weather-badge {
            position: fixed;
            top: 90px;
            right: 24px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 500;
            color: #475569;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.8);
            z-index: 100;
        }

        .weather-night .weather-badge {
            background: rgba(30, 41, 59, 0.95);
            color: #e2e8f0;
            border-color: rgba(71, 85, 105, 0.5);
        }

        .weather-badge svg {
            width: 18px;
            height: 18px;
            color: #14b8a6;
        }

        /* Layout */
        .app-layout {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width, 240px);
            min-height: 100vh;
            transition: background 0.5s ease;
        }

        /* Page Header */
        .page-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #e2e8f0;
            margin: 0;
        }

        .page-header p {
            font-size: 14px;
            color: #94a3b8;
            margin-top: 4px;
        }

        /* Page Content */
        .page-content {
            padding: 24px 32px;
        }

        /* Controls Bar */
        .controls-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }

        .controls-left {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            background: white;
            border-radius: 10px;
            padding: 4px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .view-toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            font-size: 13px;
            font-weight: 500;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .view-toggle-btn:hover {
            color: #e2e8f0;
        }

        .view-toggle-btn.active {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(20, 184, 166, 0.3);
        }

        .view-toggle-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Month Navigation */
        .month-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .month-nav-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .month-nav-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .month-nav-btn svg {
            width: 20px;
            height: 20px;
            color: #94a3b8;
        }

        .current-month {
            font-size: 18px;
            font-weight: 600;
            color: #e2e8f0;
            min-width: 180px;
            text-align: center;
        }

        .btn-today {
            padding: 10px 20px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-today:hover {
            background: #f8fafc;
            border-color: #14b8a6;
            color: #0d9488;
        }

        /* Calendar Card */
        .calendar-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-header-cell {
            padding: 16px 12px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #94a3b8;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-cell {
            min-height: 110px;
            padding: 12px;
            border-right: 1px solid #f1f5f9;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-cell:nth-child(7n) {
            border-right: none;
        }

        .calendar-cell:hover {
            background: #f8fafc;
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-radius: 8px;
        }

        .calendar-cell.other-month {
            background: #fafbfc;
        }

        .calendar-cell.other-month .day-number {
            color: #cbd5e1;
        }

        .calendar-cell.today {
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
        }

        .calendar-cell.today .day-number {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(20, 184, 166, 0.4);
        }

        .calendar-cell.past-day {
            background: #fafbfc;
        }

        .calendar-cell.past-day .day-number {
            color: #94a3b8;
        }

        .calendar-cell.past-day:hover {
            background: #f1f5f9;
        }

        .day-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .calendar-cell:hover .day-number {
            background: rgba(20, 184, 166, 0.1);
            color: #0d9488;
        }

        .calendar-cell.today:hover .day-number {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            color: white;
        }

        /* Event Dots */
        .event-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .event-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        }

        .event-dot.holiday { background: linear-gradient(135deg, #ef4444, #f87171); }
        .event-dot.sports { background: linear-gradient(135deg, #22c55e, #4ade80); }
        .event-dot.payday { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .event-dot.school { background: linear-gradient(135deg, #3b82f6, #60a5fa); }

        .event-count {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
            font-weight: 500;
        }

        /* Day Prediction Badge */
        .day-prediction {
            font-size: 10px;
            font-weight: 600;
            margin-top: 6px;
            padding: 3px 8px;
            border-radius: 6px;
            display: inline-block;
        }

        .day-prediction.low { background: rgba(20, 184, 166, 0.1); color: #0f766e; }
        .day-prediction.medium { background: rgba(20, 184, 166, 0.2); color: #0d9488; }
        .day-prediction.high { background: rgba(20, 184, 166, 0.35); color: #115e59; }

        /* Heatmap Colors */
        .calendar-cell.heatmap-1 { background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); }
        .calendar-cell.heatmap-2 { background: linear-gradient(135deg, #ccfbf1 0%, #99f6e4 100%); }
        .calendar-cell.heatmap-3 { background: linear-gradient(135deg, #99f6e4 0%, #5eead4 100%); }
        .calendar-cell.heatmap-4 { background: linear-gradient(135deg, #5eead4 0%, #2dd4bf 100%); }
        .calendar-cell.heatmap-5 { background: linear-gradient(135deg, #2dd4bf 0%, #14b8a6 100%); }
        .calendar-cell.heatmap-6 { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); }
        .calendar-cell.heatmap-7 { background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); }
        .calendar-cell.heatmap-8 { background: linear-gradient(135deg, #0f766e 0%, #115e59 100%); }
        .calendar-cell.heatmap-9 { background: linear-gradient(135deg, #115e59 0%, #134e4a 100%); }
        .calendar-cell.heatmap-10 { background: linear-gradient(135deg, #134e4a 0%, #042f2e 100%); }

        .calendar-cell.heatmap-6 .day-number,
        .calendar-cell.heatmap-7 .day-number,
        .calendar-cell.heatmap-8 .day-number,
        .calendar-cell.heatmap-9 .day-number,
        .calendar-cell.heatmap-10 .day-number {
            color: white;
        }

        .calendar-cell.heatmap-6 .event-count,
        .calendar-cell.heatmap-7 .event-count,
        .calendar-cell.heatmap-8 .event-count,
        .calendar-cell.heatmap-9 .event-count,
        .calendar-cell.heatmap-10 .event-count {
            color: rgba(255, 255, 255, 0.8);
        }

        .calendar-cell.heatmap-6 .day-prediction,
        .calendar-cell.heatmap-7 .day-prediction,
        .calendar-cell.heatmap-8 .day-prediction,
        .calendar-cell.heatmap-9 .day-prediction,
        .calendar-cell.heatmap-10 .day-prediction {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 24px;
            padding: 16px 24px;
            border-top: 1px solid #f1f5f9;
            background: #fafbfc;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #94a3b8;
            font-weight: 500;
        }

        /* Heatmap Legend */
        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 24px;
            border-top: 1px solid #f1f5f9;
            background: #fafbfc;
        }

        .heatmap-legend-label {
            font-size: 13px;
            font-weight: 500;
            color: #94a3b8;
        }

        .heatmap-scale {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            max-width: 280px;
        }

        .heatmap-scale-bar {
            flex: 1;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(90deg,
                #f0fdfa 0%,
                #99f6e4 25%,
                #14b8a6 50%,
                #0f766e 75%,
                #134e4a 100%
            );
        }

        .heatmap-scale-min,
        .heatmap-scale-max {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 500;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 520px;
            max-height: 85vh;
            overflow: hidden;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: linear-gradient(135deg, #f8fafc 0%, #f0fdfa 100%);
        }

        .modal-date {
            font-size: 24px;
            font-weight: 700;
            color: #e2e8f0;
        }

        .modal-weekday {
            font-size: 14px;
            color: #94a3b8;
            margin-top: 4px;
            font-weight: 500;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }

        .modal-close:hover {
            background: #f1f5f9;
            transform: scale(1.05);
        }

        .modal-close svg {
            width: 18px;
            height: 18px;
            color: #94a3b8;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(85vh - 100px);
        }

        .modal-section {
            margin-bottom: 24px;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #94a3b8;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-section-title svg {
            width: 14px;
            height: 14px;
        }

        /* AI Summary Card */
        .ai-summary {
            padding: 20px;
            background: linear-gradient(135deg, #f0fdfa 0%, #e0f7fa 100%);
            border-radius: 14px;
            border: 1px solid #ccfbf1;
        }

        .ai-summary-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #0d9488;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-summary-label svg {
            width: 14px;
            height: 14px;
        }

        .ai-summary-text {
            font-size: 14px;
            color: #e2e8f0;
            line-height: 1.6;
        }

        .ai-summary-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #94a3b8;
            font-size: 13px;
        }

        /* Weather Card */
        .weather-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 14px;
            border: 1px solid #bfdbfe;
        }

        .weather-icon {
            width: 52px;
            height: 52px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .weather-icon svg {
            width: 26px;
            height: 26px;
            color: #3b82f6;
        }

        .weather-details {
            flex: 1;
        }

        .weather-temp {
            font-size: 18px;
            font-weight: 600;
            color: #e2e8f0;
        }

        .weather-desc {
            font-size: 13px;
            color: #94a3b8;
            margin-top: 2px;
        }

        /* Event Card */
        .event-card {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 14px;
            background: #fafbfc;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }

        .event-card:last-child {
            margin-bottom: 0;
        }

        .event-card:hover {
            background: white;
            border-color: #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .event-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .event-card-icon.holiday { background: linear-gradient(135deg, #fee2e2, #fecaca); color: #dc2626; }
        .event-card-icon.sports { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #16a34a; }
        .event-card-icon.payday { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #d97706; }
        .event-card-icon.school { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #2563eb; }

        .event-card-icon svg {
            width: 20px;
            height: 20px;
        }

        .event-card-content {
            flex: 1;
        }

        .event-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 4px;
        }

        .event-card-name {
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
        }

        .event-card-badge {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            padding: 3px 8px;
            border-radius: 6px;
        }

        .event-card-badge.holiday { background: #fee2e2; color: #b91c1c; }
        .event-card-badge.sports { background: #dcfce7; color: #15803d; }
        .event-card-badge.payday { background: #fef3c7; color: #b45309; }
        .event-card-badge.school { background: #dbeafe; color: #1d4ed8; }

        .event-card-teams {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            margin-top: 4px;
        }

        .event-card-teams .team {
            font-weight: 600;
            color: #475569;
        }

        .event-card-teams .team.home { color: #16a34a; }
        .event-card-teams .team.away { color: #2563eb; }
        .event-card-teams .vs {
            font-size: 11px;
            font-weight: 500;
            color: #94a3b8;
        }

        .event-card-venue,
        .event-card-description {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .no-events {
            text-align: center;
            padding: 24px;
            color: #94a3b8;
            font-size: 14px;
        }

        /* Prediction Card */
        .prediction-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            border-radius: 14px;
            border: 1px solid #99f6e4;
        }

        .prediction-card .weather-icon {
            background: #ccfbf1;
        }

        .prediction-card .weather-icon svg {
            color: #0d9488;
        }

        /* View Forecast Button */
        .btn-view-forecast {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .btn-view-forecast:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(20, 184, 166, 0.35);
        }

        .btn-view-forecast svg {
            width: 18px;
            height: 18px;
        }

        /* List View Styles */
        .events-list {
            display: none;
        }

        .events-list.active {
            display: block;
        }

        .event-group {
            padding: 20px 24px;
            border-bottom: 1px solid #f1f5f9;
        }

        .event-group:last-child {
            border-bottom: none;
        }

        .event-group-date {
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .event-group-weekday {
            font-size: 13px;
            font-weight: 400;
            color: #94a3b8;
        }

        .event-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }

        .event-type-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .event-type-badge.holiday { background: #fee2e2; color: #b91c1c; }
        .event-type-badge.sports { background: #dcfce7; color: #15803d; }
        .event-type-badge.payday { background: #fef3c7; color: #b45309; }
        .event-type-badge.school { background: #dbeafe; color: #1d4ed8; }

        .event-name {
            font-size: 14px;
            color: #e2e8f0;
        }

        .empty-state {
            text-align: center;
            padding: 64px 24px;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            color: #cbd5e1;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 16px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
            color: #94a3b8;
        }

        /* Spinner */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid #e2e8f0;
            border-top-color: #14b8a6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }

            .sidebar {
                display: none;
            }

            .page-header {
                padding: 20px;
            }

            .page-content {
                padding: 16px;
            }

            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .controls-left {
                flex-wrap: wrap;
            }

            .calendar-cell {
                min-height: 70px;
                padding: 8px;
            }

            .day-number {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .day-prediction {
                display: none;
            }

            .weather-badge {
                top: auto;
                bottom: 16px;
                right: 16px;
            }
        }

        /* Dark Mode - Techy Theme */
        [data-theme="dark"] .main-content {
            background: var(--techy-bg-void, #0a0a0f);
        }

        [data-theme="dark"] .page-header {
            background: linear-gradient(135deg, var(--techy-bg-card, #12121a) 0%, var(--techy-bg-elevated, #1e1e2a) 100%);
            border-bottom: 1px solid var(--techy-border-dark, rgba(255, 255, 255, 0.08));
        }

        [data-theme="dark"] .page-header h1 {
            color: var(--techy-text-primary, #f1f5f9);
        }

        [data-theme="dark"] .controls-bar {
            background: var(--techy-gradient-card, linear-gradient(145deg, #12121a 0%, #1a1a24 100%));
            border-color: var(--techy-border-dark, rgba(255, 255, 255, 0.08));
        }

        [data-theme="dark"] .month-nav-btn {
            background: var(--techy-bg-void, #0a0a0f);
            border-color: var(--techy-border-dark, rgba(255, 255, 255, 0.08));
            color: var(--techy-text-secondary, #94a3b8);
        }

        [data-theme="dark"] .month-nav-btn:hover {
            background: var(--techy-bg-card-hover, #1a1a24);
            border-color: var(--techy-border-glow, rgba(20, 184, 166, 0.3));
        }

        [data-theme="dark"] .month-year-text {
            color: var(--techy-text-primary, #f1f5f9);
        }

        [data-theme="dark"] .calendar-header {
            border-color: var(--techy-border-dark, rgba(255, 255, 255, 0.08));
        }

        [data-theme="dark"] .calendar-day-header {
            color: var(--techy-text-muted, #64748b);
            background: var(--techy-bg-card, #12121a);
        }

        [data-theme="dark"] .calendar-cell {
            background: var(--techy-bg-card, #12121a);
            border-color: var(--techy-border-dark, rgba(255, 255, 255, 0.08));
        }

        [data-theme="dark"] .calendar-cell:hover {
            background: var(--techy-bg-card-hover, #1a1a24);
            border-color: var(--techy-border-glow, rgba(20, 184, 166, 0.3));
        }

        [data-theme="dark"] .calendar-cell.today {
            background: rgba(20, 184, 166, 0.15);
            border-color: var(--techy-primary-light, #14b8a6);
        }

        [data-theme="dark"] .calendar-cell.other-month {
            background: var(--techy-bg-void, #0a0a0f);
        }

        [data-theme="dark"] .day-number {
            color: var(--techy-text-primary, #f1f5f9);
        }

        [data-theme="dark"] .calendar-cell.other-month .day-number {
            color: var(--techy-text-muted, #64748b);
        }

        [data-theme="dark"] .day-prediction {
            background: var(--techy-bg-void, #0a0a0f);
            color: var(--techy-text-primary, #f1f5f9);
        }

        [data-theme="dark"] .day-trend {
            color: var(--techy-text-secondary, #94a3b8);
        }

        [data-theme="dark"] .forecast-legend {
            background: var(--techy-bg-card, #12121a);
            border-color: var(--techy-border-dark, rgba(255, 255, 255, 0.08));
        }

        [data-theme="dark"] .legend-label {
            color: var(--techy-text-secondary, #94a3b8);
        }

        [data-theme="dark"] .sidebar {
            background: linear-gradient(180deg, var(--techy-bg-card, #12121a) 0%, var(--techy-bg-elevated, #1e1e2a) 100%);
            border-right: 1px solid var(--techy-border-dark, rgba(255, 255, 255, 0.08));
        }

        [data-theme="dark"] .sidebar-item:hover {
            background: var(--techy-bg-card-hover, #1a1a24);
        }

        [data-theme="dark"] .sidebar-item.active {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.15) 0%, rgba(94, 234, 212, 0.1) 100%);
            border-left: 3px solid var(--techy-primary-light, #14b8a6);
        }

        [data-theme="dark"] select {
            background: var(--techy-bg-void, #0a0a0f);
            border-color: var(--techy-border-dark, rgba(255, 255, 255, 0.08));
            color: var(--techy-text-primary, #f1f5f9);
        }
    </style>
</head>
<body>
    <!-- Techy Background Effects -->
    <div class="techy-bg-grid"></div>
    <div class="techy-glow techy-glow-1 sidebar-offset"></div>
    <div class="techy-glow techy-glow-2 sidebar-offset"></div>

    <!-- Weather Effects Container -->
    <div class="weather-effects" id="weatherEffects"></div>

    <!-- Weather Badge -->
    <div class="weather-badge" id="weatherBadge" style="display: none;">
        <span id="weatherBadgeIcon"></span>
        <span id="weatherBadgeText">Loading...</span>
    </div>

    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/frontend/pages/home.html" class="sidebar-logo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    TrucastAI
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <a href="/frontend/pages/dashboard.html" class="sidebar-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                        </svg>
                        Dashboard
                    </a>
                    <a href="/frontend/pages/forecast.html" class="sidebar-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"/>
                            <path d="M18 9l-5-6-4 8-3-2"/>
                        </svg>
                        Forecasts
                    </a>
                    <a href="/frontend/pages/calendar.html" class="sidebar-item active">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        Calendar
                    </a>
                    <a href="/frontend/pages/upload.html" class="sidebar-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Upload Data
                    </a>
                    <a href="/frontend/pages/analytics.html" class="sidebar-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"/>
                            <line x1="12" y1="20" x2="12" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="14"/>
                        </svg>
                        Analytics
                    </a>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Settings</div>
                    <a href="/frontend/pages/account.html" class="sidebar-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        Account
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1>Events Calendar</h1>
                    <p>View upcoming events and predicted sales patterns</p>
                </div>
            </div>

            <div class="page-content">
                <!-- Controls -->
                <div class="controls-bar">
                    <div class="controls-left">
                        <!-- View Toggle -->
                        <div class="view-toggle">
                            <button class="view-toggle-btn active" id="gridViewBtn" onclick="setView('grid')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                </svg>
                                Grid
                            </button>
                            <button class="view-toggle-btn" id="listViewBtn" onclick="setView('list')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="8" y1="6" x2="21" y2="6"/>
                                    <line x1="8" y1="12" x2="21" y2="12"/>
                                    <line x1="8" y1="18" x2="21" y2="18"/>
                                    <line x1="3" y1="6" x2="3.01" y2="6"/>
                                    <line x1="3" y1="12" x2="3.01" y2="12"/>
                                    <line x1="3" y1="18" x2="3.01" y2="18"/>
                                </svg>
                                List
                            </button>
                        </div>
                    </div>

                    <!-- Month Navigation -->
                    <div class="month-nav">
                        <button class="month-nav-btn" onclick="prevMonth()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 18l-6-6 6-6"/>
                            </svg>
                        </button>
                        <div class="current-month" id="currentMonth">January 2024</div>
                        <button class="month-nav-btn" onclick="nextMonth()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 18l6-6-6-6"/>
                            </svg>
                        </button>
                        <button class="btn-today" onclick="goToToday()">Today</button>
                    </div>
                </div>

                <!-- Calendar Card -->
                <div class="calendar-card">
                    <!-- Grid View -->
                    <div id="gridView">
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be rendered here -->
                        </div>
                    </div>

                    <!-- List View -->
                    <div class="events-list" id="listView">
                        <div id="eventsListContent">
                            <!-- Events list will be rendered here -->
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="legend">
                        <div class="legend-item">
                            <div class="event-dot holiday"></div>
                            Holidays
                        </div>
                        <div class="legend-item">
                            <div class="event-dot sports"></div>
                            Sports
                        </div>
                        <div class="legend-item">
                            <div class="event-dot payday"></div>
                            Paydays
                        </div>
                        <div class="legend-item">
                            <div class="event-dot school"></div>
                            School
                        </div>
                    </div>

                    <!-- Heatmap Legend -->
                    <div class="heatmap-legend" id="heatmapLegend" style="display: none;">
                        <span class="heatmap-legend-label">Predicted Traffic:</span>
                        <span class="heatmap-scale-min">Slow</span>
                        <div class="heatmap-scale">
                            <div class="heatmap-scale-bar"></div>
                        </div>
                        <span class="heatmap-scale-max">Busy</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Day Detail Modal -->
    <div class="modal-overlay" id="dayModal" onclick="closeDayModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <div class="modal-date" id="modalDate">January 15, 2024</div>
                    <div class="modal-weekday" id="modalWeekday">Wednesday</div>
                </div>
                <button class="modal-close" onclick="closeDayModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- AI Summary -->
                <div class="modal-section" id="aiSummarySection">
                    <div class="ai-summary">
                        <div class="ai-summary-label">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a10 10 0 1 0 10 10H12V2z"/>
                                <path d="M12 2a10 10 0 0 1 10 10"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            AI Insight
                        </div>
                        <div class="ai-summary-text" id="aiSummaryText">
                            <div class="ai-summary-loading">
                                <div class="spinner"></div>
                                Analyzing day factors...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weather -->
                <div class="modal-section" id="weatherSection">
                    <div class="modal-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="4"/>
                            <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
                        </svg>
                        Weather Forecast
                    </div>
                    <div class="weather-card" id="weatherCard">
                        <div class="weather-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="4"/>
                                <path d="M12 2v2M12 20v2"/>
                            </svg>
                        </div>
                        <div class="weather-details">
                            <div class="weather-temp" id="weatherTemp">72F / 58F</div>
                            <div class="weather-desc" id="weatherDesc">Clear skies, no precipitation</div>
                        </div>
                    </div>
                </div>

                <!-- Events -->
                <div class="modal-section" id="eventsSection">
                    <div class="modal-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                        </svg>
                        Events
                    </div>
                    <div id="modalEventsList">
                        <!-- Events will be populated here -->
                    </div>
                </div>

                <!-- Prediction Summary -->
                <div class="modal-section" id="predictionSection" style="display: none;">
                    <div class="modal-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"/>
                            <path d="M18 9l-5-6-4 8-3-2"/>
                        </svg>
                        Predicted Sales
                    </div>
                    <div id="predictionCard" class="prediction-card">
                        <div class="weather-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3v18h18"/>
                                <path d="M18 9l-5-6-4 8-3-2"/>
                            </svg>
                        </div>
                        <div class="weather-details">
                            <div class="weather-temp" id="predictionQty">-- units</div>
                            <div class="weather-desc" id="predictionDesc">Loading prediction data...</div>
                        </div>
                    </div>
                </div>

                <!-- View Forecast Button -->
                <div class="modal-section">
                    <a href="#" id="viewForecastBtn" class="btn-view-forecast">
                        View Sales Forecast
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="/frontend/js/api.js"></script>
    <script src="/frontend/js/chat-widget.js"></script>
    <script>
        if (!api.isAuthenticated()) {
            window.location.href = '/frontend/pages/login.html';
        }

        let currentDate = new Date();
        let currentView = 'grid';
        let businessId = null;
        let eventsData = {};
        let predictionsData = {};
        let predictionRange = { min: 0, max: 0 };

        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        async function init() {
            try {
                const businesses = await api.getBusinesses();
                if (!businesses || businesses.length === 0) {
                    showEmptyState('No business configured');
                    return;
                }
                businessId = businesses[0].id;

                // Load events and predictions in parallel for faster loading
                await Promise.all([loadEvents(), loadPredictions()]);
                renderCalendar();
                applyWeatherEffects(); // Use already-fetched weather data
            } catch (error) {
                console.error('Init error:', error);
            }
        }

        async function loadEvents() {
            if (!businessId) return;

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0);

            try {
                const response = await fetch(
                    `/api/businesses/${businessId}/events?start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}`,
                    { headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` } }
                );

                if (response.ok) {
                    eventsData = await response.json();
                } else {
                    eventsData = { holidays: [], sports: [], paydays: [], school: [], weather: [] };
                }
            } catch (error) {
                console.error('Failed to load events:', error);
                eventsData = { holidays: [], sports: [], paydays: [], school: [], weather: [] };
            }
        }

        async function loadPredictions() {
            if (!businessId) return;

            try {
                const modelsResponse = await fetch(
                    `/api/businesses/${businessId}/models`,
                    { headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` } }
                );

                if (!modelsResponse.ok) {
                    predictionsData = {};
                    return;
                }

                const models = await modelsResponse.json();
                const activeModel = models.find(m => m.is_active);

                if (!activeModel) {
                    predictionsData = {};
                    document.getElementById('heatmapLegend').style.display = 'none';
                    return;
                }

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);

                const startPrediction = (year === today.getFullYear() && month === today.getMonth())
                    ? today
                    : firstDay;

                const daysToPredict = Math.ceil((lastDay - startPrediction) / (1000 * 60 * 60 * 24)) + 1;

                if (daysToPredict <= 0) {
                    predictionsData = {};
                    document.getElementById('heatmapLegend').style.display = 'none';
                    return;
                }

                const predictResponse = await fetch(
                    `/api/models/${activeModel.id}/predict`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ days: daysToPredict })
                    }
                );

                if (!predictResponse.ok) {
                    predictionsData = {};
                    return;
                }

                const predictData = await predictResponse.json();
                const predictions = predictData.predictions || [];

                predictionsData = {};
                predictions.forEach(p => {
                    const date = p.date;
                    if (!predictionsData[date]) {
                        predictionsData[date] = { totalQty: 0, totalRevenue: 0, items: [] };
                    }
                    predictionsData[date].totalQty += p.predicted_quantity || 0;
                    predictionsData[date].totalRevenue += p.predicted_revenue || 0;
                    predictionsData[date].items.push(p);
                });

                const totals = Object.values(predictionsData).map(d => d.totalQty);
                if (totals.length > 0) {
                    predictionRange.min = Math.min(...totals);
                    predictionRange.max = Math.max(...totals);
                    document.getElementById('heatmapLegend').style.display = 'flex';
                } else {
                    document.getElementById('heatmapLegend').style.display = 'none';
                }

            } catch (error) {
                console.error('Failed to load predictions:', error);
                predictionsData = {};
            }
        }

        function getHeatmapLevel(dateStr) {
            const prediction = predictionsData[dateStr];
            if (!prediction || predictionRange.max === predictionRange.min) return 0;

            const value = prediction.totalQty;
            const range = predictionRange.max - predictionRange.min;
            const normalized = (value - predictionRange.min) / range;

            return Math.max(1, Math.min(10, Math.ceil(normalized * 10)));
        }

        function getPredictionLabel(dateStr) {
            const prediction = predictionsData[dateStr];
            if (!prediction) return null;

            const level = getHeatmapLevel(dateStr);
            let label = 'low';
            if (level >= 7) label = 'high';
            else if (level >= 4) label = 'medium';

            return {
                qty: prediction.totalQty,
                label: label
            };
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function setView(view) {
            currentView = view;
            document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');
            document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
            document.getElementById('gridView').style.display = view === 'grid' ? 'block' : 'none';
            document.getElementById('listView').classList.toggle('active', view === 'list');
            renderCalendar();
        }

        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            loadEvents();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            loadEvents();
        }

        function goToToday() {
            currentDate = new Date();
            loadEvents();
        }

        function getEventsForDate(dateStr) {
            const events = [];

            if (eventsData.holidays) {
                eventsData.holidays.filter(h => h.date === dateStr).forEach(h => {
                    events.push({
                        type: 'holiday',
                        name: h.name,
                        date: h.date,
                        description: 'Public Holiday'
                    });
                });
            }
            if (eventsData.sports) {
                eventsData.sports.filter(s => s.date === dateStr).forEach(s => {
                    events.push({
                        type: 'sports',
                        name: s.name,
                        date: s.date,
                        home_team: s.home_team,
                        away_team: s.away_team,
                        venue: s.venue,
                        description: s.venue ? `at ${s.venue}` : 'Game Day'
                    });
                });
            }
            if (eventsData.paydays) {
                eventsData.paydays.filter(p => p.date === dateStr).forEach(p => {
                    events.push({
                        type: 'payday',
                        name: p.name || 'Payday',
                        date: p.date,
                        description: 'Expected increase in customer spending'
                    });
                });
            }
            if (eventsData.school) {
                eventsData.school.forEach(s => {
                    const startDate = s.start_date;
                    const endDate = s.end_date || s.start_date;
                    if (dateStr >= startDate && dateStr <= endDate) {
                        events.push({
                            type: 'school',
                            name: s.name,
                            date: dateStr,
                            description: s.type === 'break' ? 'School Break Period' : 'School Event'
                        });
                    }
                });
            }

            return events;
        }

        function renderCalendar() {
            document.getElementById('currentMonth').textContent =
                `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

            if (currentView === 'grid') {
                renderGridView();
            } else {
                renderListView();
            }
        }

        function renderGridView() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            dayNames.forEach(day => {
                const cell = document.createElement('div');
                cell.className = 'calendar-header-cell';
                cell.textContent = day;
                grid.appendChild(cell);
            });

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const startDayOfWeek = firstDay.getDay();
            const prevMonthLastDay = new Date(year, month, 0).getDate();

            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                const cell = createDayCell(day, true, false);
                grid.appendChild(cell);
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                date.setHours(0, 0, 0, 0);
                const isToday = date.getTime() === today.getTime();
                const isPast = date < today;
                const dateStr = formatDate(date);
                const events = getEventsForDate(dateStr);
                const cell = createDayCell(day, false, isToday, events, dateStr, isPast);
                grid.appendChild(cell);
            }

            const endDayOfWeek = lastDay.getDay();
            for (let i = 1; i < 7 - endDayOfWeek; i++) {
                const cell = createDayCell(i, true, false);
                grid.appendChild(cell);
            }
        }

        function createDayCell(day, isOtherMonth, isToday, events = [], dateStr = '', isPast = false) {
            const cell = document.createElement('div');
            cell.className = 'calendar-cell';
            if (isOtherMonth) cell.className += ' other-month';
            if (isToday) cell.className += ' today';
            if (isPast && !isToday) cell.className += ' past-day';

            if (!isOtherMonth && !isPast && dateStr) {
                const heatmapLevel = getHeatmapLevel(dateStr);
                if (heatmapLevel > 0) {
                    cell.className += ` heatmap-${heatmapLevel}`;
                }
            }

            let html = `<div class="day-number">${day}</div>`;

            if (events.length > 0) {
                html += '<div class="event-dots">';
                const uniqueTypes = [...new Set(events.map(e => e.type))];
                uniqueTypes.forEach(type => {
                    html += `<div class="event-dot ${type}"></div>`;
                });
                html += '</div>';
                html += `<div class="event-count">${events.length} event${events.length > 1 ? 's' : ''}</div>`;
            }

            if (!isOtherMonth && !isPast && dateStr) {
                const predLabel = getPredictionLabel(dateStr);
                if (predLabel) {
                    html += `<div class="day-prediction ${predLabel.label}">${predLabel.qty} units</div>`;
                }
            }

            cell.innerHTML = html;

            if (dateStr && !isOtherMonth) {
                cell.onclick = () => openDayModal(dateStr, events, isPast, isToday);
            }

            return cell;
        }

        function openDayModal(dateStr, events, isPast = false, isToday = false) {
            const date = new Date(dateStr + 'T00:00:00');
            const fullDayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

            document.getElementById('modalDate').textContent =
                `${monthNames[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
            document.getElementById('modalWeekday').textContent = fullDayNames[date.getDay()] +
                (isPast && !isToday ? ' (Past)' : isToday ? ' (Today)' : '');

            document.getElementById('viewForecastBtn').href = `/frontend/pages/forecast.html?date=${dateStr}`;

            renderModalEvents(events);

            document.getElementById('aiSummaryText').innerHTML = `
                <div class="ai-summary-loading">
                    <div class="spinner"></div>
                    Analyzing day factors...
                </div>
            `;

            const weatherSection = document.getElementById('weatherSection');
            if (isToday) {
                weatherSection.style.display = 'block';
                document.getElementById('weatherTemp').textContent = '--F / --F';
                document.getElementById('weatherDesc').textContent = 'Loading weather data...';
            } else {
                weatherSection.style.display = 'none';
            }

            const predictionSection = document.getElementById('predictionSection');
            const prediction = predictionsData[dateStr];

            if (!isPast && prediction) {
                predictionSection.style.display = 'block';
                document.getElementById('predictionQty').textContent = `${prediction.totalQty} units`;

                const level = getHeatmapLevel(dateStr);
                let levelDesc = 'Normal';
                let bgColor = '#f0fdfa, #ccfbf1';
                let iconBg = '#ccfbf1';
                let iconColor = '#0d9488';

                if (level >= 8) {
                    levelDesc = 'Very Busy Day';
                    bgColor = '#0d9488, #0f766e';
                    iconBg = '#14b8a6';
                    iconColor = '#042f2e';
                } else if (level >= 6) {
                    levelDesc = 'Busy Day';
                    bgColor = '#14b8a6, #0d9488';
                    iconBg = '#2dd4bf';
                    iconColor = '#0f766e';
                } else if (level >= 4) {
                    levelDesc = 'Moderate Traffic';
                    bgColor = '#5eead4, #2dd4bf';
                    iconBg = '#99f6e4';
                    iconColor = '#0d9488';
                } else if (level >= 2) {
                    levelDesc = 'Light Traffic';
                } else {
                    levelDesc = 'Slow Day';
                }

                let revenueText = '';
                if (prediction.totalRevenue > 0) {
                    revenueText = ` | Est. Revenue: $${prediction.totalRevenue.toLocaleString()}`;
                }

                document.getElementById('predictionDesc').textContent = `${levelDesc}${revenueText}`;

                const predCard = document.getElementById('predictionCard');
                predCard.style.background = `linear-gradient(135deg, ${bgColor})`;
                predCard.querySelector('.weather-icon').style.background = iconBg;
                predCard.querySelector('.weather-icon svg').style.color = iconColor;
            } else {
                predictionSection.style.display = 'none';
            }

            document.getElementById('dayModal').classList.add('active');

            fetchDayDetails(dateStr, events, isToday);
        }

        function closeDayModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('dayModal').classList.remove('active');
        }

        function renderModalEvents(events) {
            const container = document.getElementById('modalEventsList');

            if (!events || events.length === 0) {
                container.innerHTML = '<div class="no-events">No special events on this day</div>';
                return;
            }

            const icons = {
                holiday: '<rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>',
                sports: '<circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12h8"/>',
                payday: '<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>',
                school: '<path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 2 2 3 6 3s6-1 6-3v-5"/>'
            };

            container.innerHTML = events.map(e => {
                let detailsHtml = '';

                if (e.type === 'sports' && e.home_team && e.away_team) {
                    detailsHtml = `
                        <div class="event-card-teams">
                            <span class="team home">${e.home_team}</span>
                            <span class="vs">vs</span>
                            <span class="team away">${e.away_team}</span>
                        </div>
                        ${e.venue ? `<div class="event-card-venue">${e.venue}</div>` : ''}
                    `;
                } else {
                    detailsHtml = `<div class="event-card-description">${e.description || ''}</div>`;
                }

                return `
                    <div class="event-card ${e.type}">
                        <div class="event-card-icon ${e.type}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                ${icons[e.type] || icons.holiday}
                            </svg>
                        </div>
                        <div class="event-card-content">
                            <div class="event-card-header">
                                <div class="event-card-name">${e.name}</div>
                                <span class="event-card-badge ${e.type}">${e.type}</span>
                            </div>
                            ${detailsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function fetchDayDetails(dateStr, events, isToday = false) {
            if (isToday) {
                try {
                    const response = await fetch(
                        `/api/businesses/${businessId}/events?date=${dateStr}`,
                        { headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` } }
                    );

                    if (response.ok) {
                        const data = await response.json();

                        if (data.weather && data.weather.length > 0) {
                            const weather = data.weather[0];
                            document.getElementById('weatherTemp').textContent =
                                `${weather.temp_max || '--'}F / ${weather.temp_min || '--'}F`;
                            document.getElementById('weatherDesc').textContent =
                                weather.precipitation > 0 ? `${weather.precipitation}" precipitation expected` : 'No precipitation expected';
                        } else {
                            document.getElementById('weatherDesc').textContent = 'Weather data not available';
                        }
                    }
                } catch (error) {
                    console.error('Failed to fetch weather:', error);
                    document.getElementById('weatherDesc').textContent = 'Weather data not available';
                }
            }

            fetchAISummary(dateStr, events);
        }

        async function fetchAISummary(dateStr, events) {
            try {
                const eventsPayload = {
                    holidays: events.filter(e => e.type === 'holiday'),
                    sports: events.filter(e => e.type === 'sports'),
                    paydays: events.filter(e => e.type === 'payday'),
                    school: events.filter(e => e.type === 'school')
                };

                const result = await api.summarizeDay(dateStr, eventsPayload);

                if (result && result.success) {
                    document.getElementById('aiSummaryText').textContent = result.content;
                } else if (result && !result.available) {
                    showAIUnavailable();
                } else {
                    showAIUnavailable();
                }
            } catch (error) {
                console.error('AI summary error:', error);
                showAIUnavailable();
            }
        }

        function showAIUnavailable() {
            document.getElementById('aiSummaryText').innerHTML =
                '<span style="color: #94a3b8;">AI insights unavailable. Configure OpenRouter API key to enable AI summaries.</span>';
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeDayModal();
        });

        function renderListView() {
            const container = document.getElementById('eventsListContent');
            container.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const lastDay = new Date(year, month + 1, 0).getDate();

            let hasEvents = false;

            for (let day = 1; day <= lastDay; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDate(date);
                const events = getEventsForDate(dateStr);

                if (events.length > 0) {
                    hasEvents = true;
                    const group = document.createElement('div');
                    group.className = 'event-group';

                    const weekday = dayNames[date.getDay()];
                    group.innerHTML = `
                        <div class="event-group-date">
                            ${monthNames[month]} ${day}, ${year}
                            <span class="event-group-weekday">${weekday}</span>
                        </div>
                    `;

                    events.forEach(event => {
                        const item = document.createElement('div');
                        item.className = 'event-list-item';
                        item.innerHTML = `
                            <span class="event-type-badge ${event.type}">${event.type}</span>
                            <span class="event-name">${event.name}</span>
                        `;
                        group.appendChild(item);
                    });

                    container.appendChild(group);
                }
            }

            if (!hasEvents) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="4" width="18" height="18" rx="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <h3>No events this month</h3>
                        <p>There are no special events scheduled for this month.</p>
                    </div>
                `;
            }
        }

        function showEmptyState(message) {
            document.getElementById('calendarGrid').innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <p style="color: #94a3b8;">${message}</p>
                </div>
            `;
        }

        // Weather Visual Effects
        const weatherIcons = {
            sunny: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>',
            cloudy: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>',
            rainy: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 13v8M8 13v8M12 15v8M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg>',
            snowy: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"/><line x1="8" y1="16" x2="8.01" y2="16"/><line x1="8" y1="20" x2="8.01" y2="20"/><line x1="12" y1="18" x2="12.01" y2="18"/><line x1="12" y1="22" x2="12.01" y2="22"/><line x1="16" y1="16" x2="16.01" y2="16"/><line x1="16" y1="20" x2="16.01" y2="20"/></svg>',
            night: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>'
        };

        function getWeatherType(weatherCode, isNight) {
            if (isNight && weatherCode < 3) return 'night';
            if (weatherCode === 0 || weatherCode === 1) return 'sunny';
            if (weatherCode >= 2 && weatherCode <= 3) return 'cloudy';
            if (weatherCode >= 45 && weatherCode <= 48) return 'cloudy';
            if (weatherCode >= 51 && weatherCode <= 67) return 'rainy';
            if (weatherCode >= 71 && weatherCode <= 77) return 'snowy';
            if (weatherCode >= 80 && weatherCode <= 82) return 'rainy';
            if (weatherCode >= 85 && weatherCode <= 86) return 'snowy';
            if (weatherCode >= 95) return 'rainy';
            return 'sunny';
        }

        function createRainDrops(container, count = 40) {
            for (let i = 0; i < count; i++) {
                const drop = document.createElement('div');
                drop.className = 'rain-drop';
                drop.style.left = Math.random() * 100 + '%';
                drop.style.animationDuration = (0.6 + Math.random() * 0.4) + 's';
                drop.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(drop);
            }
        }

        function createSnowflakes(container, count = 30) {
            const snowChars = ['*', '+', '.'];
            for (let i = 0; i < count; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.textContent = snowChars[Math.floor(Math.random() * snowChars.length)];
                flake.style.left = Math.random() * 100 + '%';
                flake.style.fontSize = (8 + Math.random() * 10) + 'px';
                flake.style.animationDuration = (6 + Math.random() * 8) + 's';
                flake.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(flake);
            }
        }

        function createStars(container, count = 40) {
            for (let i = 0; i < count; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 35 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                container.appendChild(star);
            }
        }

        function createClouds(container) {
            for (let i = 1; i <= 3; i++) {
                const cloud = document.createElement('div');
                cloud.className = `cloud cloud-${i}`;
                container.appendChild(cloud);
            }
        }

        function applyWeatherEffects() {
            if (!businessId || !eventsData.weather) return;

            try {
                // Use already-fetched weather data instead of making another API call
                const today = new Date().toISOString().split('T')[0];
                const weather = eventsData.weather.find(w => w.date === today) || eventsData.weather[0];

                if (!weather) return;

                const hour = new Date().getHours();
                const isNight = hour >= 19 || hour < 6;

                const weatherCode = weather.weather_code || 0;
                const weatherType = getWeatherType(weatherCode, isNight);

                document.body.classList.remove('weather-sunny', 'weather-cloudy', 'weather-rainy', 'weather-snowy', 'weather-night');
                document.body.classList.add(`weather-${weatherType}`);

                const effectsContainer = document.getElementById('weatherEffects');
                effectsContainer.innerHTML = '';

                if (weatherType === 'sunny') {
                    const sun = document.createElement('div');
                    sun.className = 'sun';
                    effectsContainer.appendChild(sun);
                } else if (weatherType === 'cloudy') {
                    createClouds(effectsContainer);
                } else if (weatherType === 'rainy') {
                    const rain = document.createElement('div');
                    rain.className = 'rain';
                    createRainDrops(rain, 40);
                    effectsContainer.appendChild(rain);
                    createClouds(effectsContainer);
                } else if (weatherType === 'snowy') {
                    createSnowflakes(effectsContainer, 30);
                    createClouds(effectsContainer);
                } else if (weatherType === 'night') {
                    createStars(effectsContainer, 40);
                    const moon = document.createElement('div');
                    moon.className = 'moon';
                    effectsContainer.appendChild(moon);
                }

                const badge = document.getElementById('weatherBadge');
                const badgeIcon = document.getElementById('weatherBadgeIcon');
                const badgeText = document.getElementById('weatherBadgeText');

                badgeIcon.innerHTML = weatherIcons[weatherType];
                const tempF = weather.temp_max ? `${Math.round(weather.temp_max)}F` : '--';
                const descriptions = {
                    sunny: 'Clear & Sunny',
                    cloudy: 'Cloudy',
                    rainy: 'Rainy',
                    snowy: 'Snowy',
                    night: 'Clear Night'
                };
                badgeText.textContent = `${descriptions[weatherType]} | ${tempF}`;
                badge.style.display = 'flex';

            } catch (error) {
                console.error('Failed to apply weather effects:', error);
            }
        }

        init();
    </script>
</body>
</html>
