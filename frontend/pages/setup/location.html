<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Location - TrucastAI</title>
    <link rel="stylesheet" href="/frontend/css/main.css">
    <link rel="stylesheet" href="/frontend/css/components.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #1e293b;
        }

        .setup-page {
            min-height: 100vh;
            padding: 40px 24px;
        }

        .setup-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .setup-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .setup-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 22px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 32px;
        }

        .setup-logo svg {
            width: 32px;
            height: 32px;
            color: #14B8A6;
        }

        /* Progress Steps */
        .setup-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 48px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-dot {
            width: 36px;
            min-width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: linear-gradient(135deg, #0D9488 0%, #14B8A6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(20, 184, 166, 0.4);
        }

        .progress-dot.complete {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .progress-dot.pending {
            background: #e2e8f0;
            color: #94a3b8;
            border: 1px solid #cbd5e1;
        }

        .progress-label {
            font-size: 13px;
            font-weight: 500;
            color: #94a3b8;
        }

        .progress-step.active .progress-label {
            color: #1e293b;
        }

        .progress-line {
            width: 20px;
            height: 2px;
            background: #e2e8f0;
            flex-shrink: 0;
        }

        .progress-line.complete {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .setup-title {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
        }

        .setup-subtitle {
            font-size: 16px;
            color: #64748b;
        }

        /* Location Form */
        .setup-form {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .form-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .form-section-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .location-count {
            font-size: 13px;
            color: #64748b;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 8px;
        }

        .input, .select {
            width: 100%;
            padding: 12px 16px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            color: #1e293b;
            transition: all 0.2s ease;
        }

        .input::placeholder {
            color: #94a3b8;
        }

        .input:focus, .select:focus {
            outline: none;
            border-color: #14B8A6;
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
        }

        .input:disabled {
            background: #f8fafc;
            color: #64748b;
        }

        .select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2314B8A6' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .select option {
            background: #ffffff;
            color: #1e293b;
        }

        /* Address Search Autocomplete */
        .address-search-container {
            position: relative;
        }

        .address-search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: #94a3b8;
            pointer-events: none;
        }

        .address-search-input {
            padding-left: 44px !important;
        }

        .address-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
            z-index: 100;
            max-height: 280px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
        }

        .address-dropdown.active {
            display: block;
        }

        .address-option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.15s ease;
            border-bottom: 1px solid #f1f5f9;
        }

        .address-option:last-child {
            border-bottom: none;
        }

        .address-option:hover {
            background: #f8fafc;
        }

        .address-option-icon {
            width: 36px;
            height: 36px;
            background: rgba(20, 184, 166, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .address-option-icon svg {
            width: 18px;
            height: 18px;
            color: #14B8A6;
        }

        .address-option-content {
            flex: 1;
            min-width: 0;
        }

        .address-option-main {
            font-size: 14px;
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .address-option-secondary {
            font-size: 12px;
            color: #64748b;
        }

        .address-loading {
            padding: 20px;
            text-align: center;
            color: #64748b;
            font-size: 14px;
        }

        .address-loading .spinner-sm {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top-color: #14B8A6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        .address-empty {
            padding: 20px;
            text-align: center;
            color: #94a3b8;
            font-size: 14px;
        }

        .selected-address-preview {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(20, 184, 166, 0.05);
            border: 1px solid rgba(20, 184, 166, 0.2);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .selected-address-preview.hidden {
            display: none;
        }

        .selected-address-icon {
            width: 40px;
            height: 40px;
            background: rgba(20, 184, 166, 0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selected-address-icon svg {
            width: 20px;
            height: 20px;
            color: #0D9488;
        }

        .selected-address-content {
            flex: 1;
        }

        .selected-address-main {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .selected-address-secondary {
            font-size: 13px;
            color: #64748b;
            margin-top: 2px;
        }

        .btn-change-address {
            padding: 8px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-change-address:hover {
            background: #f8fafc;
            border-color: #14B8A6;
            color: #0D9488;
        }

        /* Store Hours Section */
        .store-hours-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .days-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .day-checkbox:hover {
            border-color: #14B8A6;
            background: rgba(20, 184, 166, 0.05);
        }

        .day-checkbox input {
            display: none;
        }

        .day-checkbox span {
            font-size: 13px;
            color: #64748b;
        }

        .day-checkbox input:checked + span {
            color: #0D9488;
            font-weight: 600;
        }

        .day-checkbox:has(input:checked) {
            background: rgba(20, 184, 166, 0.1);
            border-color: #14B8A6;
        }

        /* Location Cards */
        .locations-list {
            margin-bottom: 24px;
        }

        .location-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .location-card.primary {
            border-color: #14B8A6;
            background: rgba(20, 184, 166, 0.05);
        }

        .location-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .location-icon {
            width: 44px;
            height: 44px;
            background: rgba(20, 184, 166, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-icon svg {
            width: 22px;
            height: 22px;
            stroke: #14B8A6;
        }

        .location-details h4 {
            font-size: 15px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .location-details p {
            font-size: 13px;
            color: #64748b;
        }

        .location-badge {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 10px;
            background: rgba(20, 184, 166, 0.1);
            color: #0D9488;
            margin-left: 8px;
        }

        .location-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border: none;
            background: #f8fafc;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            background: #e2e8f0;
        }

        .btn-icon.delete:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .btn-icon svg {
            width: 16px;
            height: 16px;
            stroke: #64748b;
        }

        .btn-icon.delete:hover svg {
            stroke: #ef4444;
        }

        /* Add Location Button */
        .add-location-btn {
            width: 100%;
            padding: 20px;
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #64748b;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-bottom: 32px;
        }

        .add-location-btn:hover {
            border-color: #14B8A6;
            color: #0D9488;
            background: rgba(20, 184, 166, 0.05);
        }

        .add-location-btn svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
        }

        /* Actions */
        .setup-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-ghost {
            background: #ffffff;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .btn-ghost:hover {
            background: #f8fafc;
            color: #1e293b;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0D9488 0%, #14B8A6 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(20, 184, 166, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn svg {
            width: 18px;
            height: 18px;
        }

        .form-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 640px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .progress-label {
                display: none;
            }

            .setup-title {
                font-size: 26px;
            }
        }
    </style>
</head>
<body>
    <div class="setup-page">
        <div class="setup-container">
            <div class="setup-header">
                <div class="setup-logo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#14B8A6" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    TrucastAI
                </div>

                <div class="setup-progress">
                    <div class="progress-step">
                        <div class="progress-dot complete">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <span class="progress-label">Store Type</span>
                    </div>
                    <div class="progress-line complete"></div>
                    <div class="progress-step">
                        <div class="progress-dot complete">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <span class="progress-label">Category</span>
                    </div>
                    <div class="progress-line complete"></div>
                    <div class="progress-step">
                        <div class="progress-dot complete">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <span class="progress-label">Data Source</span>
                    </div>
                    <div class="progress-line complete"></div>
                    <div class="progress-step active">
                        <div class="progress-dot active">4</div>
                        <span class="progress-label">Location</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="progress-step">
                        <div class="progress-dot pending">5</div>
                        <span class="progress-label">Complete</span>
                    </div>
                </div>

                <h1 class="setup-title">Add your business locations</h1>
                <p class="setup-subtitle">Search for your address and we'll auto-fill the details.</p>
            </div>

            <!-- Saved Locations List -->
            <div class="locations-list" id="locationsList">
                <!-- Locations will be rendered here -->
            </div>

            <!-- Add Location Button (shown when there are saved locations) -->
            <button class="add-location-btn" id="addLocationBtn" onclick="showLocationForm()" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Another Location
            </button>

            <!-- Location Form -->
            <form class="setup-form" id="locationForm" onsubmit="addLocation(event)">
                <div class="form-section-header">
                    <h3 id="formTitle">Add Location</h3>
                    <span class="location-count" id="locationCount"></span>
                </div>

                <div class="form-group">
                    <label class="label" for="businessName">Location Name *</label>
                    <input type="text" class="input" id="businessName" placeholder="Downtown Coffee Shop" required>
                </div>

                <!-- Selected Address Preview -->
                <div class="selected-address-preview hidden" id="selectedAddressPreview">
                    <div class="selected-address-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                    </div>
                    <div class="selected-address-content">
                        <div class="selected-address-main" id="selectedAddressMain">123 Main St</div>
                        <div class="selected-address-secondary" id="selectedAddressSecondary">Denver, CO 80202</div>
                    </div>
                    <button type="button" class="btn-change-address" onclick="changeAddress()">Change</button>
                </div>

                <!-- Address Search -->
                <div class="form-group" id="addressSearchGroup">
                    <label class="label" for="addressSearch">Search Address *</label>
                    <div class="address-search-container">
                        <svg class="address-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        <input type="text" class="input address-search-input" id="addressSearch"
                               placeholder="Start typing an address..."
                               autocomplete="off"
                               oninput="handleAddressSearch(this.value)">
                        <div class="address-dropdown" id="addressDropdown">
                            <!-- Results will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Hidden fields for address components -->
                <input type="hidden" id="address">
                <input type="hidden" id="city">
                <input type="hidden" id="state">
                <input type="hidden" id="zipcode">
                <input type="hidden" id="country" value="US">
                <input type="hidden" id="latitude">
                <input type="hidden" id="longitude">

                <div class="form-group">
                    <label class="label" for="timezone">Timezone</label>
                    <select class="input select" id="timezone">
                        <option value="America/New_York">Eastern Time (ET)</option>
                        <option value="America/Chicago">Central Time (CT)</option>
                        <option value="America/Denver">Mountain Time (MT)</option>
                        <option value="America/Los_Angeles">Pacific Time (PT)</option>
                        <option value="America/Anchorage">Alaska Time (AKT)</option>
                        <option value="Pacific/Honolulu">Hawaii Time (HT)</option>
                    </select>
                </div>

                <!-- Store Hours Section -->
                <div class="store-hours-section">
                    <label class="label" style="margin-bottom: 12px; display: block;">Store Hours</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="label" for="openTime" style="font-size: 13px;">Opening Time</label>
                            <input type="time" class="input" id="openTime" value="09:00" required>
                        </div>
                        <div class="form-group">
                            <label class="label" for="closeTime" style="font-size: 13px;">Closing Time</label>
                            <input type="time" class="input" id="closeTime" value="21:00" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="label" style="margin-bottom: 8px; font-size: 13px;">Days Open</label>
                        <div class="days-selector">
                            <label class="day-checkbox">
                                <input type="checkbox" name="daysOpen" value="mon" checked>
                                <span>Mon</span>
                            </label>
                            <label class="day-checkbox">
                                <input type="checkbox" name="daysOpen" value="tue" checked>
                                <span>Tue</span>
                            </label>
                            <label class="day-checkbox">
                                <input type="checkbox" name="daysOpen" value="wed" checked>
                                <span>Wed</span>
                            </label>
                            <label class="day-checkbox">
                                <input type="checkbox" name="daysOpen" value="thu" checked>
                                <span>Thu</span>
                            </label>
                            <label class="day-checkbox">
                                <input type="checkbox" name="daysOpen" value="fri" checked>
                                <span>Fri</span>
                            </label>
                            <label class="day-checkbox">
                                <input type="checkbox" name="daysOpen" value="sat" checked>
                                <span>Sat</span>
                            </label>
                            <label class="day-checkbox">
                                <input type="checkbox" name="daysOpen" value="sun" checked>
                                <span>Sun</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-buttons">
                    <button type="button" class="btn btn-ghost" onclick="cancelLocationForm()" id="cancelBtn" style="display: none;">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="addLocationBtn2" disabled>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Location
                    </button>
                </div>
            </form>

            <div class="setup-actions">
                <button class="btn btn-ghost" onclick="goBack()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back
                </button>
                <button class="btn btn-primary" onclick="finishSetup()" id="continueBtn" disabled>
                    Continue
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script src="/frontend/js/api.js"></script>
    <script>
        // Check authentication
        if (!api.isAuthenticated()) {
            window.location.href = '/frontend/pages/login.html';
        }

        // Check if store type is online - redirect to online details page
        const storeType = sessionStorage.getItem('setup_store_type');
        if (storeType === 'online') {
            window.location.href = '/frontend/pages/setup/online-details.html';
        }

        // Check if business type was selected
        const businessType = sessionStorage.getItem('setup_business_type');
        if (!businessType) {
            window.location.href = '/frontend/pages/setup/business-type.html';
        }

        // Store locations temporarily
        let locations = [];
        let editingIndex = -1;
        let searchTimeout = null;
        let addressSelected = false;

        function goBack() {
            window.location.href = '/frontend/pages/setup/integrations.html';
        }

        // Address search using Nominatim (OpenStreetMap) - free geocoding
        async function handleAddressSearch(query) {
            const dropdown = document.getElementById('addressDropdown');

            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (query.length < 3) {
                dropdown.classList.remove('active');
                return;
            }

            // Show loading
            dropdown.innerHTML = '<div class="address-loading"><span class="spinner-sm"></span>Searching...</div>';
            dropdown.classList.add('active');

            // Debounce the search
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&countrycodes=us,ca,gb,au&q=${encodeURIComponent(query)}`,
                        {
                            headers: {
                                'Accept': 'application/json',
                                'User-Agent': 'TrucastAI/1.0'
                            }
                        }
                    );

                    if (!response.ok) throw new Error('Search failed');

                    const results = await response.json();

                    if (results.length === 0) {
                        dropdown.innerHTML = '<div class="address-empty">No addresses found. Try a different search.</div>';
                        return;
                    }

                    // Filter and format results
                    const formatted = results
                        .filter(r => r.address && (r.address.city || r.address.town || r.address.village || r.address.municipality))
                        .slice(0, 6)
                        .map(r => {
                            const addr = r.address;
                            const street = [addr.house_number, addr.road].filter(Boolean).join(' ');
                            const city = addr.city || addr.town || addr.village || addr.municipality || '';
                            const state = addr.state || addr.county || '';
                            const stateCode = getStateCode(state);
                            const zipcode = addr.postcode || '';
                            const country = addr.country_code?.toUpperCase() || 'US';

                            return {
                                display_name: r.display_name,
                                street: street,
                                city: city,
                                state: stateCode,
                                zipcode: zipcode,
                                country: country,
                                lat: r.lat,
                                lon: r.lon
                            };
                        });

                    if (formatted.length === 0) {
                        dropdown.innerHTML = '<div class="address-empty">No valid addresses found. Try adding more details.</div>';
                        return;
                    }

                    dropdown.innerHTML = formatted.map((addr, i) => `
                        <div class="address-option" onclick="selectAddress(${i})">
                            <div class="address-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                    <circle cx="12" cy="10" r="3"/>
                                </svg>
                            </div>
                            <div class="address-option-content">
                                <div class="address-option-main">${addr.street || addr.city}</div>
                                <div class="address-option-secondary">${addr.city}, ${addr.state} ${addr.zipcode}</div>
                            </div>
                        </div>
                    `).join('');

                    // Store results for selection
                    window.searchResults = formatted;

                } catch (error) {
                    console.error('Address search error:', error);
                    dropdown.innerHTML = '<div class="address-empty">Search failed. Please try again.</div>';
                }
            }, 400);
        }

        // Convert full state name to abbreviation
        function getStateCode(stateName) {
            const states = {
                'alabama': 'AL', 'alaska': 'AK', 'arizona': 'AZ', 'arkansas': 'AR', 'california': 'CA',
                'colorado': 'CO', 'connecticut': 'CT', 'delaware': 'DE', 'florida': 'FL', 'georgia': 'GA',
                'hawaii': 'HI', 'idaho': 'ID', 'illinois': 'IL', 'indiana': 'IN', 'iowa': 'IA',
                'kansas': 'KS', 'kentucky': 'KY', 'louisiana': 'LA', 'maine': 'ME', 'maryland': 'MD',
                'massachusetts': 'MA', 'michigan': 'MI', 'minnesota': 'MN', 'mississippi': 'MS', 'missouri': 'MO',
                'montana': 'MT', 'nebraska': 'NE', 'nevada': 'NV', 'new hampshire': 'NH', 'new jersey': 'NJ',
                'new mexico': 'NM', 'new york': 'NY', 'north carolina': 'NC', 'north dakota': 'ND', 'ohio': 'OH',
                'oklahoma': 'OK', 'oregon': 'OR', 'pennsylvania': 'PA', 'rhode island': 'RI', 'south carolina': 'SC',
                'south dakota': 'SD', 'tennessee': 'TN', 'texas': 'TX', 'utah': 'UT', 'vermont': 'VT',
                'virginia': 'VA', 'washington': 'WA', 'west virginia': 'WV', 'wisconsin': 'WI', 'wyoming': 'WY',
                'district of columbia': 'DC'
            };
            const lower = stateName.toLowerCase();
            return states[lower] || stateName.substring(0, 2).toUpperCase();
        }

        function selectAddress(index) {
            const addr = window.searchResults[index];

            // Fill hidden fields
            document.getElementById('address').value = addr.street;
            document.getElementById('city').value = addr.city;
            document.getElementById('state').value = addr.state;
            document.getElementById('zipcode').value = addr.zipcode;
            document.getElementById('country').value = addr.country;
            document.getElementById('latitude').value = addr.lat;
            document.getElementById('longitude').value = addr.lon;

            // Auto-select timezone based on state
            autoSelectTimezone(addr.state);

            // Show selected address preview
            document.getElementById('selectedAddressMain').textContent = addr.street || addr.city;
            document.getElementById('selectedAddressSecondary').textContent = `${addr.city}, ${addr.state} ${addr.zipcode}`;
            document.getElementById('selectedAddressPreview').classList.remove('hidden');
            document.getElementById('addressSearchGroup').style.display = 'none';

            // Close dropdown and clear search
            document.getElementById('addressDropdown').classList.remove('active');
            document.getElementById('addressSearch').value = '';

            addressSelected = true;
            validateForm();
        }

        function changeAddress() {
            document.getElementById('selectedAddressPreview').classList.add('hidden');
            document.getElementById('addressSearchGroup').style.display = 'block';
            document.getElementById('addressSearch').focus();
            addressSelected = false;
            validateForm();
        }

        function autoSelectTimezone(state) {
            const timezones = {
                // Eastern
                'CT': 'America/New_York', 'DE': 'America/New_York', 'FL': 'America/New_York',
                'GA': 'America/New_York', 'IN': 'America/New_York', 'KY': 'America/New_York',
                'ME': 'America/New_York', 'MD': 'America/New_York', 'MA': 'America/New_York',
                'MI': 'America/New_York', 'NH': 'America/New_York', 'NJ': 'America/New_York',
                'NY': 'America/New_York', 'NC': 'America/New_York', 'OH': 'America/New_York',
                'PA': 'America/New_York', 'RI': 'America/New_York', 'SC': 'America/New_York',
                'VT': 'America/New_York', 'VA': 'America/New_York', 'WV': 'America/New_York',
                'DC': 'America/New_York',
                // Central
                'AL': 'America/Chicago', 'AR': 'America/Chicago', 'IL': 'America/Chicago',
                'IA': 'America/Chicago', 'KS': 'America/Chicago', 'LA': 'America/Chicago',
                'MN': 'America/Chicago', 'MS': 'America/Chicago', 'MO': 'America/Chicago',
                'NE': 'America/Chicago', 'ND': 'America/Chicago', 'OK': 'America/Chicago',
                'SD': 'America/Chicago', 'TN': 'America/Chicago', 'TX': 'America/Chicago',
                'WI': 'America/Chicago',
                // Mountain
                'AZ': 'America/Denver', 'CO': 'America/Denver', 'ID': 'America/Denver',
                'MT': 'America/Denver', 'NM': 'America/Denver', 'UT': 'America/Denver',
                'WY': 'America/Denver',
                // Pacific
                'CA': 'America/Los_Angeles', 'NV': 'America/Los_Angeles', 'OR': 'America/Los_Angeles',
                'WA': 'America/Los_Angeles',
                // Alaska
                'AK': 'America/Anchorage',
                // Hawaii
                'HI': 'Pacific/Honolulu'
            };

            const tz = timezones[state];
            if (tz) {
                document.getElementById('timezone').value = tz;
            }
        }

        function validateForm() {
            const name = document.getElementById('businessName').value.trim();
            const btn = document.getElementById('addLocationBtn2');
            btn.disabled = !name || !addressSelected;
        }

        // Add input listener for business name
        document.getElementById('businessName').addEventListener('input', validateForm);

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const container = document.querySelector('.address-search-container');
            if (container && !container.contains(e.target)) {
                document.getElementById('addressDropdown').classList.remove('active');
            }
        });

        function renderLocations() {
            const container = document.getElementById('locationsList');
            const addBtn = document.getElementById('addLocationBtn');
            const continueBtn = document.getElementById('continueBtn');
            const locationCount = document.getElementById('locationCount');

            if (locations.length === 0) {
                container.innerHTML = '';
                addBtn.style.display = 'none';
                continueBtn.disabled = true;
                locationCount.textContent = '';
                return;
            }

            locationCount.textContent = `${locations.length} location${locations.length > 1 ? 's' : ''} added`;
            continueBtn.disabled = false;
            addBtn.style.display = 'flex';

            container.innerHTML = locations.map((loc, index) => `
                <div class="location-card ${index === 0 ? 'primary' : ''}">
                    <div class="location-info">
                        <div class="location-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                        </div>
                        <div class="location-details">
                            <h4>
                                ${loc.name}
                                ${index === 0 ? '<span class="location-badge">Primary</span>' : ''}
                            </h4>
                            <p>${loc.address ? loc.address + ', ' : ''}${loc.city}, ${loc.state} ${loc.zipcode}</p>
                        </div>
                    </div>
                    <div class="location-actions">
                        <button class="btn-icon" onclick="editLocation(${index})" title="Edit">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="btn-icon delete" onclick="removeLocation(${index})" title="Remove">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getSelectedDays() {
            const checkboxes = document.querySelectorAll('input[name="daysOpen"]:checked');
            return Array.from(checkboxes).map(cb => cb.value).join(',');
        }

        function setSelectedDays(daysString) {
            const days = daysString ? daysString.split(',') : [];
            document.querySelectorAll('input[name="daysOpen"]').forEach(cb => {
                cb.checked = days.includes(cb.value);
            });
        }

        function addLocation(e) {
            e.preventDefault();

            const locationData = {
                name: document.getElementById('businessName').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value.toUpperCase(),
                zipcode: document.getElementById('zipcode').value,
                country: document.getElementById('country').value,
                latitude: parseFloat(document.getElementById('latitude').value) || null,
                longitude: parseFloat(document.getElementById('longitude').value) || null,
                timezone: document.getElementById('timezone').value,
                open_time: document.getElementById('openTime').value,
                close_time: document.getElementById('closeTime').value,
                days_open: getSelectedDays()
            };

            if (editingIndex >= 0) {
                locations[editingIndex] = locationData;
                editingIndex = -1;
            } else {
                locations.push(locationData);
            }

            renderLocations();
            resetForm();
            hideLocationForm();
        }

        function editLocation(index) {
            const loc = locations[index];
            editingIndex = index;

            document.getElementById('businessName').value = loc.name;
            document.getElementById('address').value = loc.address || '';
            document.getElementById('city').value = loc.city;
            document.getElementById('state').value = loc.state;
            document.getElementById('zipcode').value = loc.zipcode;
            document.getElementById('country').value = loc.country;
            document.getElementById('latitude').value = loc.latitude || '';
            document.getElementById('longitude').value = loc.longitude || '';
            document.getElementById('timezone').value = loc.timezone;
            document.getElementById('openTime').value = loc.open_time || '09:00';
            document.getElementById('closeTime').value = loc.close_time || '21:00';
            setSelectedDays(loc.days_open || 'mon,tue,wed,thu,fri,sat,sun');

            // Show selected address preview
            document.getElementById('selectedAddressMain').textContent = loc.address || loc.city;
            document.getElementById('selectedAddressSecondary').textContent = `${loc.city}, ${loc.state} ${loc.zipcode}`;
            document.getElementById('selectedAddressPreview').classList.remove('hidden');
            document.getElementById('addressSearchGroup').style.display = 'none';
            addressSelected = true;

            document.getElementById('formTitle').textContent = 'Edit Location';
            document.getElementById('addLocationBtn2').innerHTML = `
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                Save Changes
            `;
            document.getElementById('addLocationBtn2').disabled = false;

            showLocationForm();
        }

        function removeLocation(index) {
            if (confirm('Remove this location?')) {
                locations.splice(index, 1);
                renderLocations();
            }
        }

        function showLocationForm() {
            document.getElementById('locationForm').style.display = 'block';
            document.getElementById('addLocationBtn').style.display = 'none';
            if (locations.length > 0) {
                document.getElementById('cancelBtn').style.display = 'block';
            }
        }

        function hideLocationForm() {
            if (locations.length > 0) {
                document.getElementById('locationForm').style.display = 'none';
                document.getElementById('addLocationBtn').style.display = 'flex';
            }
        }

        function cancelLocationForm() {
            editingIndex = -1;
            resetForm();
            hideLocationForm();
        }

        function resetForm() {
            document.getElementById('locationForm').reset();
            document.getElementById('formTitle').textContent = 'Add Location';
            document.getElementById('addLocationBtn2').innerHTML = `
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Location
            `;
            document.getElementById('addLocationBtn2').disabled = true;

            // Reset address selection
            document.getElementById('selectedAddressPreview').classList.add('hidden');
            document.getElementById('addressSearchGroup').style.display = 'block';
            addressSelected = false;

            // Reset store hours to defaults
            document.getElementById('openTime').value = '09:00';
            document.getElementById('closeTime').value = '21:00';
            setSelectedDays('mon,tue,wed,thu,fri,sat,sun');
        }

        async function finishSetup() {
            if (locations.length === 0) {
                alert('Please add at least one location');
                return;
            }

            const btn = document.getElementById('continueBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Saving...';

            try {
                const existingBusinessId = sessionStorage.getItem('setup_business_id');
                const createdBusinesses = [];

                // First location updates the existing business
                const firstLoc = locations[0];
                if (existingBusinessId) {
                    const updateData = {
                        name: firstLoc.name,
                        address: firstLoc.address,
                        city: firstLoc.city,
                        state: firstLoc.state,
                        zipcode: firstLoc.zipcode,
                        country: firstLoc.country,
                        latitude: firstLoc.latitude,
                        longitude: firstLoc.longitude,
                        timezone: firstLoc.timezone,
                        open_time: firstLoc.open_time,
                        close_time: firstLoc.close_time,
                        days_open: firstLoc.days_open
                    };

                    const business = await api.updateBusiness(existingBusinessId, updateData);
                    if (business) {
                        createdBusinesses.push(business);
                        await api.completeBusinessSetup(business.id);
                    }
                }

                // Additional locations create new businesses
                for (let i = 1; i < locations.length; i++) {
                    const loc = locations[i];
                    const businessData = {
                        name: loc.name,
                        business_type: businessType,
                        address: loc.address,
                        city: loc.city,
                        state: loc.state,
                        zipcode: loc.zipcode,
                        country: loc.country,
                        latitude: loc.latitude,
                        longitude: loc.longitude,
                        timezone: loc.timezone,
                        open_time: loc.open_time,
                        close_time: loc.close_time,
                        days_open: loc.days_open
                    };

                    const business = await api.createBusiness(businessData);
                    if (business) {
                        createdBusinesses.push(business);
                        await api.completeBusinessSetup(business.id);
                    }
                }

                if (createdBusinesses.length > 0) {
                    // Store first business ID as primary
                    sessionStorage.setItem('setup_business_id', createdBusinesses[0].id);
                    sessionStorage.setItem('setup_locations_count', createdBusinesses.length);

                    // Navigate to complete page
                    window.location.href = '/frontend/pages/setup/complete.html';
                }
            } catch (error) {
                console.error('Error saving businesses:', error);
                alert(error.message || 'Failed to save business. Please try again.');
                btn.disabled = false;
                btn.innerHTML = 'Continue <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
            }
        }

        // Initialize
        renderLocations();
    </script>
</body>
</html>
